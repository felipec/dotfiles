#!/usr/bin/env ruby

@authors = {}
$alias_file = "~/.mutt/aliases"

def reverse_alias(name)
  r = `grep '#{name}' #{$alias_file}`
  return r[/<.*>/]
end

def parse_blame(line)
  key, value = line.split(" ", 2)
  case key
  when "author"
    @name = value
  when "author-mail"
    @mail = value
    a = reverse_alias(@name)
    @mail = a if a
    author = "\"#{@name}\" #{@mail}"
    @authors[author] ||= 0
    @authors[author] += 1
  end
end

ARGV.each do |filename|
  open(filename).each do |l|
    @from ||= l[/From (\w+)/, 1]
    case l
    when /^---\s+(\S+)/
      @source = $1[2..-1]
      # TODO /dev/null
    when /^@@\s-(\d+),(\d+)/
      blame = `git blame --incremental -L #{$1},+#{$2} #{@source} #{@from}^ | grep author`
      blame.each_line { |l| parse_blame(l.chomp) }
    end
  end
end

@authors.sort { |a,b| a[1] <=> b[1] }.reverse.each do |a,c|
  puts a, c
end
